<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArtSpace HUD | Mastermind Control Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="toast-container"></div>

  <!-- Mastermind Sidebar -->
  <aside class="master-sidebar">
    <div class="sidebar-header">
      <div
        style="width: 40px; height: 40px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; box-shadow: 0 0 20px var(--primary-glow);">
        A</div>
      <h1>ArtSpace <span>HUD</span></h1>
    </div>
    <nav class="sidebar-nav">
      <a class="nav-item active" onclick="showTab('overview', this)"><span>üìä</span> Dashboard</a>
      <a class="nav-item" onclick="showTab('artworks', this)"><span>üé®</span> Artworks</a>
      <a class="nav-item" onclick="showTab('users', this)"><span>üë•</span> Users</a>
      <a class="nav-item" onclick="showTab('sales', this)"><span>üí∞</span> Sales</a>
      <a class="nav-item" onclick="showTab('analytics', this)"><span>üèÜ</span> Analytics</a>
      <a class="nav-item" onclick="showTab('reviews', this)"><span>üí¨</span> Moderation</a>
      <a class="nav-item" onclick="showTab('settings', this)"><span>‚öô</span> Settings</a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" style="width:100%" onclick="logout()">Terminate Session</button>
    </div>
  </aside>

  <!-- Main Master Viewport -->
  <main class="main-viewport">
    <div class="top-bar">
      <div class="omni-search">
        <input type="text" placeholder="Omni-Search: Find users, art, or commands..."
          oninput="handleOmniSearch(this.value)">
      </div>
      <div class="header-actions">
        <a href="../index.html" class="secondary-btn">View Live Site</a>
      </div>
    </div>

    <!-- Bulk Action Bar (Hidden by default) -->
    <div id="bulk-bar">
      <span id="bulk-count">0 items selected</span>
      <div style="display: flex; gap: 0.8rem;">
        <button class="bulk-btn" onclick="bulkAction('verify')">Verify All</button>
        <button class="bulk-btn" onclick="bulkAction('feature')">Feature All</button>
        <button class="bulk-btn danger" onclick="bulkAction('delete')">Delete All</button>
      </div>
      <button class="secondary-btn" style="padding: 0.3rem 0.6rem; font-size: 0.7rem;"
        onclick="clearSelection()">Cancel</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active animate-slide">
      <section>
        <h2><span>‚ö°</span> Real-Time HUD Meters</h2>
        <div class="gauge-container">
          <div class="glass-card animate-scale">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span class="stat-label">Inventory Health</span>
              <span id="stat-artworks" class="stat-value" style="font-size: 1.2rem;">-</span>
            </div>
            <div class="meter">
              <div id="meter-inventory" class="meter-fill"></div>
            </div>
          </div>
          <div class="glass-card animate-scale" style="animation-delay: 0.1s">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span class="stat-label">User Reach</span>
              <span id="stat-users" class="stat-value" style="font-size: 1.2rem;">-</span>
            </div>
            <div class="meter">
              <div id="meter-users" class="meter-fill" style="background:var(--accent)"></div>
            </div>
          </div>
          <div class="glass-card animate-scale" style="animation-delay: 0.2s">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span class="stat-label">Sales Conversion</span>
              <span id="stat-sales" class="stat-value" style="font-size: 1.2rem;">-</span>
            </div>
            <div class="meter">
              <div id="meter-sales" class="meter-fill" style="background:#f59e0b"></div>
            </div>
          </div>
          <div class="glass-card animate-scale" style="animation-delay: 0.3s">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span class="stat-label">Total Revenue</span>
              <span id="stat-revenue" class="stat-value" style="font-size: 1.2rem; color:var(--accent)">$0</span>
            </div>
            <div class="meter">
              <div id="meter-revenue" class="meter-fill" style="background:var(--accent); width: 100%;"></div>
            </div>
          </div>
        </div>
      </section>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <section>
          <h2><span>‚ö°</span> Recent Activity</h2>
          <div id="auditLogFeed" class="glass-card" style="max-height: 480px; overflow-y: auto; padding: 0;">
            <!-- Audit logs injected here -->
          </div>
        </section>
        <section>
          <h2><span>üèÜ</span> Top Artist Spotlight</h2>
          <div class="glass-card" style="padding: 1.5rem;">
            <div id="topArtistDashboard" class="leaderboard-list">
              <!-- Top performers across categories injected here -->
            </div>
            <button class="secondary-btn" style="width: 100%; margin-top: 1rem;" onclick="showTab('analytics')">View
              Full Leaderboards</button>
          </div>
        </section>
      </div>
    </div>

    <!-- Artworks Tab -->
    <div id="artworks-tab" class="tab-content">
      <section>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
          <h2><span>‚öô</span> Manage Artworks</h2>
        </div>
        <div class="glass-card table-container">
          <table>
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" onclick="toggleSelectAll('artworks', this)"></th>
                <th>Artwork</th>
                <th>Artist</th>
                <th>Rating</th>
                <th>Status</th>
                <th>Featured</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="artworkTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <section>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
          <h2><span>üë§</span> Users & Verification</h2>
        </div>
        <div class="glass-card table-container">
          <table>
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" onclick="toggleSelectAll('users', this)"></th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Arts</th>
                <th>Revenue</th>
                <th>Verify</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Sales Tab -->
    <div id="sales-tab" class="tab-content">
      <section>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
          <h2><span>üí∞</span> Transaction History</h2>
          <input type="text" class="secondary-btn" placeholder="Search sales..."
            oninput="searchTable('salesTableBody', this.value)">
        </div>
        <div class="glass-card table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Artwork</th>
                <th>Buyer</th>
                <th>Artist</th>
                <th>Amount</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="salesTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content">
      <section>
        <h2><span>üèÜ</span> Artist Performance Leaderboards</h2>
        <div class="analytics-leaderboard-grid">
          <div class="glass-card">
            <h3>Most Productive (Artworks)</h3>
            <div id="leaderboard-most-posts" class="leaderboard-list"></div>
          </div>
          <div class="glass-card">
            <h3>Highest Rated (Quality)</h3>
            <div id="leaderboard-top-rated" class="leaderboard-list"></div>
          </div>
          <div class="glass-card">
            <h3>Top Earners (Revenue)</h3>
            <div id="leaderboard-top-earners" class="leaderboard-list"></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Reviews Tab -->
    <div id="reviews-tab" class="tab-content">
      <section>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
          <h2><span>üí¨</span> Moderation</h2>
          <input type="text" class="secondary-btn" placeholder="Search reviews..."
            oninput="searchTable('reviewTableBody', this.value)">
        </div>
        <div class="glass-card table-container">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Artwork</th>
                <th>Rating</th>
                <th>Comment</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="reviewTableBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <section>
        <h2><span>‚öô</span> Platform Configuration</h2>
        <div class="glass-card" style="max-width: 600px;">
          <form onsubmit="handleSettingsUpdate(event)">
            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Gallery Name</label>
              <input type="text" id="set-gallery-name" class="secondary-btn" style="width:100%; text-align:left;">
            </div>
            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Hero Title</label>
              <input type="text" id="set-hero-title" class="secondary-btn" style="width:100%; text-align:left;">
            </div>
            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Hero Subtitle</label>
              <textarea id="set-hero-subtitle" class="secondary-btn"
                style="width:100%; text-align:left; min-height:80px;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 2rem;">
              <label>Platform Service Fee (%)</label>
              <input type="number" id="set-fee" class="secondary-btn" style="width:100%; text-align:left;">
            </div>
            <button type="submit" class="btn-status"
              style="padding:1rem 2rem; border-radius:12px; font-weight:700;">Save All Settings</button>
          </form>
        </div>
      </section>
    </div>
  </main>

  <script>
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úî' : '‚úñ'}</span> ${message}`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
        setTimeout(() => toast.remove(), 400);
      }, 3000);
    }

    function searchTable(tbodyId, query) {
      const q = query.toLowerCase();
      const rows = document.getElementById(tbodyId).getElementsByTagName('tr');
      for (let row of rows) {
        row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
      }
    }

    async function checkAuth() {
      const resp = await fetch('../api/auth.php?action=check');
      const data = await resp.json();
      if (!data.logged_in || data.user.role !== 'admin') {
        window.location.href = 'login.html';
      }
    }

    function showTab(tabId, el) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active', 'animate-slide'));
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));

      const currentTab = document.getElementById(tabId + '-tab');
      currentTab.classList.add('active', 'animate-slide');

      if (el) el.classList.add('active');
      else {
        // Find nav item by text if el is not provided (e.g. from omni-search)
        document.querySelectorAll('.nav-item').forEach(item => {
          if (item.getAttribute('onclick').includes(tabId)) item.classList.add('active');
        });
      }

      if (tabId === 'overview') { fetchStats(); fetchAuditLogs(); }
      if (tabId === 'artworks') fetchAllArtworks();
      if (tabId === 'users') fetchUsers();
      if (tabId === 'sales') fetchSales();
      if (tabId === 'analytics') fetchAnalytics();
      if (tabId === 'reviews') fetchReviews();
      if (tabId === 'settings') loadSettings();

      clearSelection();
    }

    function handleOmniSearch(query) {
      const q = query.toLowerCase();

      // Command execution shortcuts
      if (q === '/artworks') return showTab('artworks');
      if (q === '/users') return showTab('users');
      if (q === '/settings') return showTab('settings');
      if (q === '/verify all') return bulkAction('verify');

      // Dynamic filtering based on active tab
      const activeTab = document.querySelector('.tab-content.active');
      const activeTbody = activeTab.querySelector('tbody');
      if (activeTbody) {
        const rows = activeTbody.getElementsByTagName('tr');
        for (let row of rows) {
          row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
        }
      }
    }

    // --- Bulk Operations HUD ---
    let selectedIds = [];
    function toggleSelectAll(type, master) {
      const tbodyId = type === 'artworks' ? 'artworkTableBody' : 'userTableBody';
      const checkboxes = document.getElementById(tbodyId).querySelectorAll('.bulk-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = master.checked;
        handleRowSelect(cb, cb.value);
      });
    }

    function handleRowSelect(cb, id) {
      if (cb.checked) {
        if (!selectedIds.includes(id)) selectedIds.push(id);
      } else {
        selectedIds = selectedIds.filter(i => i !== id);
      }
      updateBulkBar();
    }

    function updateBulkBar() {
      const bar = document.getElementById('bulk-bar');
      const count = document.getElementById('bulk-count');
      if (selectedIds.length > 0) {
        bar.classList.add('visible');
        count.textContent = `${selectedIds.length} items selected`;
      } else {
        bar.classList.remove('visible');
      }
    }

    function clearSelection() {
      selectedIds = [];
      document.querySelectorAll('.bulk-checkbox, input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateBulkBar();
    }

    async function bulkAction(type) {
      if (selectedIds.length === 0) return;
      if (!confirm(`Execute ${type} on ${selectedIds.length} items?`)) return;

      showToast(`Processing ${selectedIds.length} items...`);

      // Note: For simplicity, we loop the existing APIs. Pro version would have bulk endpoints.
      for (let id of selectedIds) {
        if (type === 'delete') {
          const activeTab = document.querySelector('.tab-content.active').id;
          const action = activeTab.includes('artworks') ? 'delete_artwork' : 'delete_user';
          await fetch(`../api/admin.php?action=${action}&id=${id}`, { method: 'DELETE' });
        }
        if (type === 'verify') {
          await fetch('../api/admin.php?action=toggle_verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, state: true }) // Explicitly verify
          });
        }
        if (type === 'feature') {
          await fetch('../api/admin.php?action=toggle_featured', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, state: true }) // Explicitly feature
          });
        }
      }

      showToast(`${type} operation complete!`, 'success');
      clearSelection();
      // Refresh active tab
      const activeTabId = document.querySelector('.tab-content.active').id.replace('-tab', '');
      showTab(activeTabId);
    }

    async function fetchStats() {
      const resp = await fetch('../api/admin.php?action=stats');
      const result = await resp.json();
      if (result.success) {
        const s = result.data;
        document.getElementById('stat-artworks').textContent = s.total_artworks;
        document.getElementById('stat-users').textContent = s.total_users;
        document.getElementById('stat-sales').textContent = s.total_sold;
        document.getElementById('stat-revenue').textContent = '$' + Number(s.revenue).toLocaleString();

        // Animate Meters
        document.getElementById('meter-inventory').style.width = Math.min((s.total_sold / s.total_artworks) * 100 || 0, 100) + '%';
        document.getElementById('meter-users').style.width = Math.min((s.total_users / 100) * 100, 100) + '%'; // Target 100 users
        document.getElementById('meter-sales').style.width = Math.min((s.total_sold / 50) * 100, 100) + '%'; // Target 50 sales

        fetchAnalyticsSummary();
      }
    }

    async function fetchAnalyticsSummary() {
      const resp = await fetch('../api/admin.php?action=get_analytics');
      const result = await resp.json();
      if (result.success) {
        const container = document.getElementById('topArtistDashboard');
        const d = result.data;

        let html = '';
        if (d.most_posts[0]) html += renderSummaryItem('Volume', d.most_posts[0].name, d.most_posts[0].total_posts, 'Arts');
        if (d.top_rated[0]) html += renderSummaryItem('Quality', d.top_rated[0].name, Number(d.top_rated[0].avg_rating).toFixed(1), '‚òÖ');
        if (d.top_earners[0]) html += renderSummaryItem('Revenue', d.top_earners[0].name, '$' + Number(d.top_earners[0].total_revenue).toLocaleString(), '');

        container.innerHTML = html || '<div class="empty-state">No performance data yet.</div>';
      }
    }

    function renderSummaryItem(category, name, value, unit) {
      return `
            <div class="leaderboard-item" style="background: rgba(255,255,255,0.02); margin-bottom: 0.8rem; border: 1px solid rgba(255,255,255,0.05);">
                <div class="rank" style="font-size: 0.8rem; opacity: 0.6; width: auto; margin-right: 1rem;">${category}</div>
                <div class="name" style="font-size: 1rem;">${name}</div>
                <div class="value" style="font-size: 1rem; color: var(--primary);">${value} ${unit}</div>
            </div>
        `;
    }

    async function fetchAnalytics() {
      const resp = await fetch('../api/admin.php?action=get_analytics');
      const result = await resp.json();
      if (result.success) {
        const d = result.data;

        // Render Most Productive
        const mostPostsList = document.getElementById('leaderboard-most-posts');
        mostPostsList.innerHTML = d.most_posts.length > 0 ? d.most_posts.map((u, i) => `
                        <div class="leaderboard-item">
                            <div class="rank">#${i + 1}</div>
                            <div class="name">${u.name}</div>
                            <div class="value">${u.total_posts} Arts</div>
                        </div>
                    `).join('') : '<div class="empty-state">No data available</div>';

        // Render Top Rated
        const topRatedList = document.getElementById('leaderboard-top-rated');
        topRatedList.innerHTML = d.top_rated.length > 0 ? d.top_rated.map((u, i) => `
                        <div class="leaderboard-item">
                            <div class="rank">#${i + 1}</div>
                            <div class="name">${u.name}</div>
                            <div class="value">${Number(u.avg_rating).toFixed(1)} ‚òÖ</div>
                        </div>
                    `).join('') : '<div class="empty-state">No reviews yet</div>';

        // Render Top Earners
        const topEarnersList = document.getElementById('leaderboard-top-earners');
        topEarnersList.innerHTML = d.top_earners.length > 0 ? d.top_earners.map((u, i) => `
                        <div class="leaderboard-item">
                            <div class="rank">#${i + 1}</div>
                            <div class="name">${u.name}</div>
                            <div class="value">$${Number(u.total_revenue).toLocaleString()}</div>
                        </div>
                    `).join('') : '<div class="empty-state">No revenue data</div>';
      }
    }

    async function fetchAuditLogs() {
      const resp = await fetch('../api/admin.php?action=list_logs');
      const result = await resp.json();
      if (result.success) {
        const feed = document.getElementById('auditLogFeed');
        if (result.data.length === 0) {
          feed.innerHTML = '<div class="empty-state">No activity logged.</div>';
          return;
        }
        feed.innerHTML = result.data.map(log => `
                    <div style="padding:1rem; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="color:var(--primary)">${log.action}</strong>
                            <div style="font-size:0.8rem; color:var(--text-muted)">${log.details || ''}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:0.8rem">${log.admin_name}</div>
                            <div style="font-size:0.7rem; opacity:0.6">${new Date(log.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
      }
    }

    async function fetchAllArtworks() {
      const resp = await fetch('../api/admin.php?action=list_artworks');
      const result = await resp.json();
      if (result.success) renderArtworkTable(result.data);
    }

    function renderArtworkTable(artworks) {
      const tbody = document.getElementById('artworkTableBody');
      tbody.innerHTML = artworks.map(art => `
                <tr class="${selectedIds.includes(String(art.id)) ? 'selected' : ''}">
                    <td><input type="checkbox" class="bulk-checkbox" value="${art.id}" ${selectedIds.includes(String(art.id)) ? 'checked' : ''} onchange="handleRowSelect(this, '${art.id}')"></td>
                    <td>
                        <div style="display:flex; align-items:center; gap:0.5rem">
                            <img src="../${art.image_path}" style="width:40px; height:40px; border-radius:4px; object-fit:cover">
                            <span>${art.title}</span>
                        </div>
                    </td>
                    <td>${art.artist_name}</td>
                    <td>${Number(art.avg_rating).toFixed(1)} ‚òÖ</td>
                    <td><span class="status-badge status-${art.status}">${art.status}</span></td>
                    <td>
                        <button class="action-btn btn-feature ${art.is_featured ? 'active' : ''}" onclick="toggleFeatured(${art.id})">
                            ${art.is_featured ? 'Featured ‚òÖ' : 'Feature'}
                        </button>
                    </td>
                    <td>
                        <button class="action-btn btn-status" onclick="toggleStatus(${art.id}, '${art.status}')">Toggle Status</button>
                        <button class="action-btn btn-delete" onclick="deleteArtwork(${art.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
    }

    async function fetchSales() {
      const resp = await fetch('../api/admin.php?action=list_sales');
      const result = await resp.json();
      if (result.success) {
        const tbody = document.getElementById('salesTableBody');
        if (result.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No transactions yet.</td></tr>';
          return;
        }
        tbody.innerHTML = result.data.map(s => `
                    <tr>
                        <td>#${s.id}</td>
                        <td>${s.artwork_title}</td>
                        <td>${s.buyer_name}</td>
                        <td>${s.artist_name}</td>
                        <td style="color:#10b981; font-weight:700">$${Number(s.price).toLocaleString()}</td>
                        <td>${new Date(s.created_at).toLocaleString()}</td>
                    </tr>
                `).join('');
      }
    }

    async function loadSettings() {
      const resp = await fetch('../api/admin.php?action=get_settings');
      const result = await resp.json();
      if (result.success) {
        const s = result.data;
        document.getElementById('set-gallery-name').value = s.gallery_name || '';
        document.getElementById('set-hero-title').value = s.hero_title || '';
        document.getElementById('set-hero-subtitle').value = s.hero_subtitle || '';
        document.getElementById('set-fee').value = s.platform_fee || '';
      }
    }

    async function handleSettingsUpdate(e) {
      e.preventDefault();
      const data = {
        gallery_name: document.getElementById('set-gallery-name').value,
        hero_title: document.getElementById('set-hero-title').value,
        hero_subtitle: document.getElementById('set-hero-subtitle').value,
        platform_fee: document.getElementById('set-fee').value
      };
      const resp = await fetch('../api/admin.php?action=update_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if ((await resp.json()).success) showToast('Settings saved successfully!');
    }

    // --- Reuse existing functions ---
    async function fetchUsers() {
      const resp = await fetch('../api/admin.php?action=list_users');
      const res = await resp.json();
      if (res.success) {
        document.getElementById('userTableBody').innerHTML = res.data.map(u => `
                    <tr>
                        <td><input type="checkbox" class="bulk-checkbox" value="${u.id}" ${selectedIds.includes(String(u.id)) ? 'checked' : ''} onchange="handleRowSelect(this, '${u.id}')"></td>
                        <td>${u.name} ${u.is_verified ? '<span class="verified-check">‚òë</span>' : ''}</td>
                        <td>${u.email}</td>
                        <td><span class="status-badge" style="background:rgba(255,255,255,0.05)">${u.role}</span></td>
                        <td style="font-weight:600">${u.total_artworks}</td>
                        <td style="color:#10b981; font-weight:700">$${Number(u.total_revenue).toLocaleString()}</td>
                        <td>${u.role === 'artist' ? `<button class="action-btn btn-verify ${u.is_verified ? 'active' : ''}" onclick="toggleVerify(${u.id})">${u.is_verified ? 'Verified' : 'Verify'}</button>` : '-'}</td>
                        <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        <td><button class="action-btn btn-delete" onclick="deleteUser(${u.id})">Delete</button></td>
                    </tr>
                `).join('');
      }
    }

    async function fetchReviews() {
      const resp = await fetch('../api/admin.php?action=list_reviews');
      const res = await resp.json();
      if (res.success) {
        document.getElementById('reviewTableBody').innerHTML = res.data.map(r => `
                    <tr>
                        <td>${r.user_name}</td>
                        <td>${r.artwork_title}</td>
                        <td>${'‚òÖ'.repeat(r.rating)}</td>
                        <td>${r.comment}</td>
                        <td>${new Date(r.created_at).toLocaleDateString()}</td>
                        <td><button class="action-btn btn-delete" onclick="deleteReview(${r.id})">Delete</button></td>
                    </tr>
                `).join('');
      }
    }

    async function toggleFeatured(id) {
      const r = await fetch('../api/admin.php?action=toggle_featured', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
      if ((await r.json()).success) { showToast('Featured status updated'); fetchAllArtworks(); }
    }

    async function toggleVerify(id) {
      const r = await fetch('../api/admin.php?action=toggle_verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
      if ((await r.json()).success) { showToast('Verification updated'); fetchUsers(); }
    }

    async function deleteArtwork(id) { if (confirm('Delete?')) fetch(`../api/admin.php?action=delete_artwork&id=${id}`, { method: 'DELETE' }).then(() => fetchAllArtworks()); }
    async function deleteUser(id) { if (confirm('Delete?')) fetch(`../api/admin.php?action=delete_user&id=${id}`, { method: 'DELETE' }).then(() => fetchUsers()); }
    async function deleteReview(id) { if (confirm('Delete?')) fetch(`../api/admin.php?action=delete_review&id=${id}`, { method: 'DELETE' }).then(() => fetchReviews()); }

    async function logout() { await fetch('../api/auth.php?action=logout', { method: 'POST' }); window.location.href = '../index.html'; }

    checkAuth().then(() => { fetchStats(); fetchAuditLogs(); });
  </script>
</body>

</html>